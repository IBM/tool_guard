from ibm_watsonx_orchestrate.agent_builder.tools import tool

from agent_ready_tools.clients.coupa_client import get_coupa_client
from agent_ready_tools.tools.procurement.common_dataclasses import ToolResponse
from agent_ready_tools.tools.procurement.purchase_support.coupa.purchase_support_dataclasses import (
    CoupaApproval,
)
from agent_ready_tools.tools.procurement.purchase_support.coupa.purchase_support_helper_functions import (
    coupa_build_approval_from_response,
)
from agent_ready_tools.tools.procurement.utils import coupa_format_error_string
from agent_ready_tools.utils.tool_credentials import COUPA_CONNECTIONS


@tool(expected_credentials=COUPA_CONNECTIONS)
def coupa_reject_approval_by_id(approval_id: int) -> ToolResponse[CoupaApproval]:
    """
    Rejects a pending approval in Coupa.

    Args:
        approval_id: The id of the approval.

    Returns:
        The resulting approval after rejecting.
    """
    # once an approval is rejected, the id and its record are deleted from system
    # and a new approval is autogenerated in its place
    # e.g. if approval 1001 gets rejected, when trying to retrieve the approval 1001, it will return None
    # in the requisition, an approval 1002 will be newly generated in the approvals list.
    try:
        client = get_coupa_client()
    except (ValueError, AssertionError):
        return ToolResponse(success=False, message="Failure to retrieve credentials")

    response = client.get_request(
        resource_name=f"approvals/{approval_id}",
        params={"fields": '["status", "approvable-type", "approvable-id"]'},
    )
    if "errors" in response:
        return ToolResponse(success=False, message=coupa_format_error_string(response))

    # check that requisition should be in pending approval status
    if response["approvable-type"] == "RequisitionHeader":
        requisition_id = response["approvable-id"]
        requisition = client.get_request(resource_name=f"requisitions/{requisition_id}")
        if "errors" in requisition:
            return ToolResponse(success=False, message=coupa_format_error_string(requisition))

        if requisition["status"] != "pending_approval":
            return ToolResponse(
                success=False,
                message=f"Requisition should be in 'pending_approval' status instead of '{requisition["status"]}'.",
            )

        if requisition.get("current-approval", {}).get("id") != approval_id:
            return ToolResponse(
                success=False,
                message="This approval is not the currently pending approval for this requisition.",
            )

    if response["status"] != "pending_approval":
        return ToolResponse(
            success=False, message="Approval status should be in 'pending_approval'."
        )

    response = client.put_request(resource_name=f"approvals/{approval_id}/reject")
    if "errors" in response:
        return ToolResponse(success=False, message=coupa_format_error_string(response))

    return ToolResponse(
        success=True,
        message="Approval rejected successfully.",
        content=coupa_build_approval_from_response(response),
    )
